# 注意
本ドキュメントは、あなたが提供した **「ソフトウェア開発工程管理.md」** のテンプレとゲート条件に準拠しています。
- 参照: 工程とレビューゲート（S0→S1→S2→C1→T→R）、成果物テンプレ、Gateチェック（S0/S1/S2）。
- 目的: CodexCLIに渡して、そのまま実装・審査・テストに使える粒度に落とし込むこと。

---

# 基本仕様書（CleanLink Mini v0.4）

## 用語（かんたん定義）
- **追跡パラメータ**: `utm_source` や `fbclid` など広告計測用のクエリ。削除してもページ本体は変わらないことが多い。
- **短縮URL**: `bit.ly/xxxx` のように遷移先を別URLへ転送するリンク。
- **完全ローカル**: 端末内だけで処理が完結し、短縮展開時を除きネットワーク送信を行わない設計方針。
- **自動クリーン**: ドメイン単位で Clean を自動適用する機能。Chrome 標準の optional host permissions を今後導入する前提で、現状は `<all_urls>` を利用。
- **安全除外リスト**: `login`, `auth`, `payment` などを含む URL を検出し、書き換え対象から除外する仕組み。
- **Pro ライセンス**: 一括クリーンや短縮URL展開など拡張機能を買い切りで解放するコード。署名検証により正当性を確認する。

## 1. 目的（何を実現するか）
共有するリンクを「きれい・安心・手早く」整え、相手に信頼される短いURLを素早く用意できる Chrome 拡張を提供する。
- **きれい**: 追跡パラメータを安全に除去し、URLを読みやすくする。
- **安心**: Pro 機能で短縮URLの最終遷移先を確認でき、ログイン・決済系 URL は自動で除外する。
- **手早く**: Popup 上で即 Clean / Copy が完結し、履歴で Before/After を再利用できる。

## 2. 対象ユーザーと課題（価値仮説）
| ユーザー | 課題 | CleanLink が提供する価値 |
|---|---|---|
| SNS投稿者 / ブロガー | 長くて怪しいURLは読者に嫌われる | 追跡削除と結果サマリーで「見た目が良く安全」なURLを即コピー |
| CS / 営業 | メールに多くのリンクを貼る作業が面倒 | Clean → Copy → 履歴確認を 3 手順で完了し、再利用も History からコピー |
| プライバシー重視ユーザー | 足跡や個人情報が漏れる拡張は避けたい | 完全ローカル処理・安全除外リストで安心して利用可能 |
| Pro ユーザー（業務利用） | 短縮URLの先が不明で不安 | Pro の短縮展開とライセンス検証で業務監査に耐える証跡を提供 |

## 3. ユーザーストーリー（受入基準との対応）
- **US-11 SNS投稿者**: Clean ボタンで URL を整えてシェアしたい → AC REQ-201 / REQ-202 に対応。
- **US-12 CS/営業担当**: 履歴から再利用したい → AC REQ-203 に対応。
- **US-13 Pro ユーザー**: 短縮URLの遷移先を確認したい → AC REQ-204 に対応。
- **US-14 プライバシー重視ユーザー**: 認証系 URL を安全に除外したい → AC REQ-205 に対応。

## 4. スコープ / 非スコープ
- **スコープ**
  - Popup: 「Clean」「Copy cleaned URLs」「Clean & Copy」の3アクションと結果サマリー表示
  - 履歴タブ: Before/After/Expanded を1行で確認し、Afterクリックでコピー + トースト
  - 安全除外リストとサイト別自動クリーン設定
  - Pro 機能: 一括クリーン + CSV、短縮URL展開、ライセンス管理
- **非スコープ**
  - 外部API連携・クラウド同期
  - 他ブラウザ対応（初期リリースは Chrome のみ）
  - 定期課金（買い切りのみ）

## 5. 前提と制約
- 収益モデル: フリーミアム + Pro 買い切り（初回のみ USD 4.90）。
- 技術制約: Manifest V3 準拠、基本挙動はローカル完結。短縮展開時のみ HEAD/GET を使用。
- データ制約: 利用状況の外部送信は禁止。履歴は `chrome.storage.local` の配列で最大 1,000 件に制限。
- 工程: S0→S1→S2→C1→T→R の各ゲートで承認者サインを残す。

## 6. 価格と根拠
- **価格**: USD 4.90（買い切り）。
- **根拠**:
  - 競合 Unshorten.link (年額 $7) より初年度 30% 低い。
  - 無料拡張との差別化として「履歴のBefore/After」「短縮展開」「CSV」「安全除外」を提供。
- **返金方針**: 購入から14日以内は理由を問わず返金。Options ページと README に記載。

## 7. KPI と測定方法
| KPI-ID | 指標 | ベースライン (β) | 目標 (リリース+30日) | 測定方法/頻度 | 備考 |
|---|---|---|---|---|---|
| KPI-01 | 初回体験率 (インストール→Clean 実行) | 60% | ≥ 75% | ローカル `first_run_completed` を opt-in 収集 | Popup ガイド更新後に再測定 |
| KPI-02 | Pro への転換率 | 1.5% | 2.5% | Web Store 決済レポート (月次) | ライセンス成功イベントで自己診断にも記録 |
| KPI-03 | 短縮展開利用率 | 未計測 | ≥ 45% | 履歴 `expanded=true` の件数 (月次) | Timeout 件数も追跡 |
| KPI-04 | 手動 Clean p95 | 0.28s | < 0.20s | Playwright + performance API (週次) | 短縮展開 OFF 条件 |
| KPI-05 | 重大不具合件数 | 0 | 0 | GitHub Issue (Severity P0/P1) | 発生時は 24h 以内に Hotfix |

## 8. 非機能要求 (NFR)
- **性能**: 100リンク処理で p95 < 200ms / p99 < 600ms。短縮展開はリクエスト開始から 2.5s でタイムアウト。
- **可用性**: オフライン環境でも Clean と Copy は必ず完了。短縮展開は「Couldn’t expand…」と明示。
- **セキュリティ**: login/auth/payment/account を含む URL は既定で除外。optional permissions は段階導入予定。ライセンスは署名検証。
- **アクセシビリティ**: WCAG 2.2 AA。ボタン 44px 以上、aria-live で結果通知、キーボード操作完全対応。
- **観測性**: 自己診断ログ (ローカル) に `message.kind` と結果サマリーを記録し、Options からダウンロード可能。

## 9. 主要要求 (受入基準付き)
- **REQ-201 手動クリーン（Free）**
  - Given 現在タブに HTTP/HTTPS のリンクがある
  - When ユーザーが「Clean」を押す
  - Then 追跡パラメータが除去された結果がページへ即時反映され、Popup 上に `Detected/Changed/Ignored` の数値が表示される。
- **REQ-202 Copy cleaned URLs（Free）**
  - Given 前回 Clean 実行済み
  - When 「Copy cleaned URLs」を押す
  - Then cleaned URL が改行区切りでクリップボードへ入り、「Copied!」トーストが 1.2 秒表示される。
- **REQ-203 履歴 Before/After（Free）**
  - Given 履歴が存在する
  - When History を開き After セルをクリックする
  - Then その URL がクリップボードにコピーされ右下にトーストが表示される。
- **REQ-204 短縮URL展開 (Pro)**
  - Given Pro ライセンスが有効かつ Expand short URLs が ON
  - When `bit.ly` を含むリンクを Clean する
  - Then 2.5 秒以内に最終 URL が `final` として表示され、Timeout 時は「Kept as-is (timeout)」の説明が出る。
- **REQ-205 安全除外**
  - Given URL が login/auth/payment/account などを含む
  - When Clean を実行
  - Then そのリンクは変更されず Ignored にカウントされ、履歴にも `notes=skipped-sensitive` が記録される。

## 10. リスクと対策 (Top5)
| リスク | 影響 | 回避/緩和策 |
|---|---|---|
| R-11: 追跡パラメータ削除で動作不良 | CVリンクが壊れる | ルールを JSON で定義し、除外ホワイトリストを容易に更新。サイト別 OFF を UI で提供。 |
| R-12: 短縮展開タイムアウト多発 | 価値が下がる | タイムアウト閾値を 2.5s に設定し、再試行 1 回 + 明示メッセージ。 |
| R-13: 権限エラー (chrome:// 等) | UX 低下 | Clean 実行前に host を判定し「This page can’t be cleaned」メッセージを返す。 |
| R-14: 履歴漏洩懸念 | 信頼低下 | 履歴はローカル配列で最大 1,000 件。削除ボタンとオプトアウト設定を Options に追加。 |
| R-15: ライセンス偽造 | 売上低下 | 署名検証 + デバイス署名。Options に検証結果を表示し、無効時は Pro UI をグレーアウト。 |

## 11. ロールバック戦略
- Manifest / ルール更新によるリグレッションが発生した場合、最新版を即時 Unpublish し、前バージョンを再公開する。
- 履歴データ不整合が発覚した場合、Options から JSON バックアップをダウンロードし復元手順を案内する。
- 仕様変更による重大不具合 (P0) は Gate R で即時 Revert → Issue を作成し、修正は別 PR で対応する。

## 12. 観測計画・レビュー
- KPI の集計は月次レビュー (PM/TL/QA) で実施し、S0/S1/S2 ドキュメントにエビデンスをリンク。
- Gate ごとに GitHub Issue (`gate/S0` など) を作成し、レビュー結果と承認者コメントを残す。
- ユーザーからのサポート依頼時は Options の診断ログを添付してもらうフローを FAQ に記載。

## 13. Gate S0 チェック
- KPI にベースラインと測定手段・頻度を明記済み。
- リスク Top5 と緩和策を更新済み。
- `REQ-201`〜`REQ-205` を定義し、すべて受入基準 (Given/When/Then) を記載。
- 次工程（S1）に必要な UI / フローの骨子は機能設計書で補完済み。
