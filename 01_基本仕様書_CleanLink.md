# 注意
本ドキュメントは、あなたが提供した **「ソフトウェア開発工程管理.md」** のテンプレとゲート条件に準拠して作成しています。
- 参照: 工程とレビューゲート（S0→S1→S2→C1→T→R）、成果物テンプレ、Gateチェック（S0/S1/S2）。
- 目的: CodexCLIに渡して、そのまま実装・審査・テストに使える粒度に落とし込むこと。

---

# 基本仕様書（CleanLink Mini）

## 用語（かんたん定義）
- **追跡パラメータ**: `utm_source` や `fbclid` など広告計測用のクエリ。削除してもページ本体は変わらないことが多い。
- **短縮URL**: `bit.ly/xxxx` のように遷移先を別URLへ転送するリンク。
- **完全ローカル**: 端末内だけで処理が完結し、ネットワーク送信を行わない設計方針。
- **フリーミアム**: 基本機能は無料で提供し、拡張機能を一度の課金で開放するモデル。
- **KPI**: 価値提供や品質保証を測定する指標。測定方法と頻度を定義する。
- **p95**: 100回中95番目の遅さ。p95が300msなら「95%の処理が0.3秒以下で完了」する状態。

## 1. 目的（何を実現するか）
共有するリンクを「きれい・安心・手早く」整え、相手に信頼される短いURLを素早く用意できる Chrome 拡張を提供する。
- **きれい**: 追跡パラメータを安全に除去し、URLを短く読みやすくする。
- **安心**: Pro 機能で短縮URLの最終遷移先を確認できる。
- **手早く**: 一括クリーンと CSV 出力で日常業務の手間と時間を削減する。

## 2. 対象ユーザーと課題（価値仮説）
| ユーザー | 課題 | CleanLink が提供する価値 |
|---|---|---|
| SNS投稿者 / ブロガー | 長くて怪しいURLは読者に嫌われる | 追跡削除とプレビューで「見た目が良く安全」なURLを即コピー |
| CS / 営業 | メールに多くのリンクを貼る作業が面倒 | 一括クリーンとCSVでリンク管理工数を削減 |
| 学生 / 研究者 | 引用URLが散らかって検索しにくい | CSV台帳で文献リンクを整理し再利用しやすくする |
| プライバシー重視ユーザー | 足跡や個人情報が漏れる拡張は避けたい | 完全ローカル処理・外部送信ゼロで安心して利用可能 |

## 3. スコープ / 非スコープ
- **スコープ**
  - 手動クリーン（現タブ）
  - 一括クリーン＋CSV出力（Pro）
  - 短縮URL展開プレビュー（Pro・optional permission）
  - サイト別 ON/OFF／ログ自己診断のローカル保存
- **非スコープ**
  - 外部API連携・クラウド同期
  - Firefox / Edge など他ブラウザ対応（初期リリースは Chrome のみ）
  - サーバー計測・アカウント管理

## 4. 前提と制約
- 収益モデル: フリーミアム + Pro 買い切り（初回のみ USD 4.90）。
- 技術制約: Manifest V3 準拠、完全ローカル処理、ネットワーク呼び出しは短縮URL展開時のみ。
- データ制約: 利用状況・個人情報の収集は禁止。ローカルでの集計とユーザーの明示操作によるエクスポートのみ許可。
- 工程: S0→S1→S2→C1→T→R のゲートに従い、各工程でレビュー承認を必須とする。

## 5. 価格と根拠
- **価格**: USD 4.90（買い切り）。
- **根拠**:
  - Unshorten.link 有料プラン $7/年 → 初年度コストを 30% 低く設定。
  - 追跡削除系の無料拡張（ClearURLs 等）との差別化要素として「プレビュー選択」「CSV」「完全ローカル」を提供。
- **返金方針**: 購入から14日以内は理由を問わず返金。Options ページに導線を記載。

## 6. KPI と測定方法
| KPI-ID | 指標 | ベースライン (βテスト) | 目標 (リリース+30日) | 測定方法/頻度 | 備考 |
|---|---|---|---|---|---|
| KPI-01 | 初回体験率 (インストール→Clean 実行率) | 60% (クローズドβ10名) | ≥ 70% | ローカルに `first_run_completed` を記録し、ユーザーがオプションから匿名集計ファイルをエクスポート。月次レビューで集計。 | 初回起動時に opt-in ダイアログで集計の趣旨を説明。
| KPI-02 | Pro への転換率 | 1.5% (競合調査値) | 2.0–3.5% | Web Store 決済レポート（ダッシュボード）を月次取得。 | 外部送信はしない。手動ダウンロードで記録。
| KPI-03 | Pro 内短縮展開利用率 | β未計測 | ≥ 40% | ローカル履歴の `expanded` フラグをカウントし、ユーザーがレポートをエクスポート。 | CSV レポートに含め、利用者が任意提出。
| KPI-04 | 一括処理 p95 | 0.45s (100リンク モック) | < 0.30s | Playwright + Lighthouse の自動計測を CI で週次実行。 | p99 < 0.80s も監視。
| KPI-05 | 重大不具合件数 | 0 | 0 | GitHub Issues (Severity P0/P1) を発生都度記録。 | 14日以内の返金率もレビュー。

## 7. 非機能要求 (NFR)
- **性能**: 100リンク処理で p95 < 300ms / p99 < 800ms。短縮展開は 2秒以内に結果を返すかタイムアウト。
- **可用性**: オフライン環境でも手動Cleanは常に成功。短縮展開は「保留」の明示メッセージを表示。
- **セキュリティ**: オプション権限は必要時のみ要求。外部API禁止。署名検証で Pro を解放。
- **アクセシビリティ**: WCAG 2.2 AA に準拠したコントラスト・フォーカス・キーボード操作を提供。
- **観測性**: 自己診断ログ（ローカル）に主要イベントを記録し、ユーザーが任意でサポートに送信できるようにする。

## 8. 主要要求 (受入基準付き)
- **REQ-101 手動クリーン (Free)**
  - Given 現在のタブにリンクが存在する
  - When ユーザーが「Clean」を押し「Copy Clean」を選択する
  - Then `utm_*`, `fbclid`, `gclid`, `msclkid`, `ttclid`, `igshid` などの追跡クエリが除去されたURLがクリップボードに入り、元URLとの差分がUIに表示される。
- **REQ-102 一括クリーン (Pro)**
  - Given Pro ライセンスが有効
  - When 「Bulk Clean」を実行してCSVをエクスポートする
  - Then ページ内リンクが差分置換され、`original, cleaned, final` の3列CSVがダウンロードされる。
- **REQ-103 短縮URL展開 (Pro)**
  - Given ユーザーが optional permissions を許可済み
  - When `bit.ly` など短縮URLを含むリンクをプレビューする
  - Then 最終遷移URLが 2 秒以内に表示され、失敗時は明示的にエラーメッセージを出す。
- **REQ-104 ローカル完結**
  - Given ネットワークが切断されている
  - When 手動 Clean を実行する
  - Then 全機能が外部通信なしで完了し、短縮展開は「ネットワークが必要」と表示してスキップする。

## 9. リスクと対策 (Top5)
| リスク | 影響 | 回避/緩和策 |
|---|---|---|
| R-01: 追跡パラメータを削除しすぎて動作不良 | CVリンクが壊れる | ルールをホワイトリスト優先で定義。サイト別除外設定を提供。Before/After 表示でユーザーが確認可能。
| R-02: 短縮展開で外部アクセスが疑われる | 信頼低下・審査NG | optional permissions と透明な UI 説明。HTTP メソッドは HEAD/GET のみ。ログでアクセス先を可視化し記録はローカルに限定。
| R-03: Optional permissions 付与率が低い | Pro 価値が伝わらない | 初回にメリットをモーダルで説明し、後から Options でも許可を促す。
| R-04: 有料価格への不満 | 低評価・返金 | 14日返金・機能比較表・事例ブログを用意。価格は競合比30%低。
| R-05: 海賊版拡張 | 売上低下・セキュリティリスク | 署名付きライセンス検証。実行ファイルにウォーターマーク。価格を低めに設定し不正使用の動機を下げる。

## 10. 観測計画・レビュー
- KPI 進捗は月次レビューで確認し、S0/S1/S2 のドキュメントにリンクを追記。
- 主要判断は GitHub Issue (ラベル `gate/S0`, `gate/S1`, ...) で承認履歴を残す。
- ユーザーからのログ収集は完全任意。Options から暗号化ZIPを生成し、サポートへ送れるようにする（後続リリース対象）。

## 11. Gate S0 チェック
- KPI にベースラインと測定手段を明記済み。
- リスク Top5 と緩和策を記載済み。
- `REQ-###` ごとに受入基準 (Given/When/Then) を定義済み。
- 次工程（S1）に必要な外部仕様とユーザーストーリーは機能設計書で補完する。
